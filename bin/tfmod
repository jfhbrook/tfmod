#!/usr/bin/env bash

set -euo pipefail

# Enough logging to launch TfMod

function error {
  echo -e '\e[0;31m│\e[0m'
  echo -e '\e[0;31m│ Error:\e[0m' "${1}"

  if [ -n "${2:-}" ]; then
    echo -e '\e[0;31m│\e[0m'
    echo "${2}" | while read -r line; do
      echo -e '\e[0;31m│\e[0m ' "${line}"
    done
  fi

  echo -e '\e[0;31m│\e[0m'
}

function fatal {
  error "$@"
  exit 1
}

ERR_NOT_INSTALLED="TfMod is not installed correctly"
ERR_NOT_INSTALLED_MSG="To install TfMod, run 'tfmod update'"

function fatal-not-installed {
  fatal "${ERR_NOT_INSTALLED}" "${ERR_NOT_INSTALLED_MSG}"
}

TF_LOG="${TF_LOG:-WARN}"
ARGV="$*"
COMMAND=''
SHOW_HELP=''

UNWISE_HELP='Usage: TfMod unwise

Remove TfMod and all its files.'

UPDATE_HELP='Usage: TfMod update

Install or update TfMod and its dependencies.'

while [[ $# -gt 0 ]]; do
  case "${1}" in
    -h|-help|--help)
      SHOW_HELP=1
      shift
      ;;
    update|unwise)
      if [ -z "${COMMAND}" ]; then
        COMMAND="${1}"
      fi
      shift
      ;;
    *)
      shift
      ;;
  esac
done

# unwise takes priority over everything
if [[ "${COMMAND}" == 'unwise' ]]; then
  if [ -n "${SHOW_HELP}" ]; then
    echo "${UNWISE_HELP}"
    exit 0
  fi

  rm -rf ~/.local/state/TfMod
  rm -f "${BASH_SOURCE[0]}"
  info 'TfMod is uninstalled'
  exit 0
fi

# If not cloned, we need to install TfMod
if [ ! -d ~/.local/state/TfMod ]; then
  COMMAND='install'
fi

# If we're not installing, run
if [[ "${COMMAND}" != 'update' ]]; then
  cd ~/.local/state/TfMod || fatal-not-installed
  [ -d .venv ] || fatal-not-installed

  # rather than using uv, just use the virtualenv directly...

  # shellcheck disable=SC1091
  source .venv/bin/activate
  exec python3 -m TfMod "${ARGV[@]}"
fi

#
# Installer/updater
#
# This follows the regular code path in an effort to help
# avoid unneeded interpreting on the part of bash and hopefully
# make things imperceptibly faster
#

if [ -n "${SHOW_HELP}" ]; then
  echo "${UPDATE_HELP}"
  exit 0
fi

# More logging functions

function log {
  # TODO: Terraform shows fractional seconds...
  TS="$(date +"%Y-%m-%dT%H:%M:%S%z")"
  local level
  level="${1}"
  shift
  echo "${TS} ${level}" "$@" 1>&2
}

function is-trace {
  [[ "${TF_LOG}" == 'TRACE' ]]
}

function is-debug {
  [[ "${TF_LOG}" == 'DEBUG' ]] || is-trace
}

function is-info {
  [[ "${TF_LOG}" == 'INFO' ]] || is-debug
}

function is-warn {
  [[ "${TF_LOG}" == 'WARN' ]] || is-info
}

function debug {
  if is-debug; then
    log '[DEBUG]' "$@"
  fi
}

function info {
  if is-info; then
    log '[INFO] ' "$@"
  fi
}

function warn {
  if is-warn; then
    log '[WARN] ' "$@"
  fi
}

function ok {
  echo -e "\e[0;92m${1}\e[0m"
}

function quote {
  if ! is-info; then
    return 0
  fi
  while read -r line; do
    echo "  │ ${line}"
  done
}

# Ensure log level is set correctly
case "${TF_LOG}" in
  TRACE|DEBUG|INFO|WARN|ERROR)
    ;;
  *)
    TF_LOG='WARN'
    log-warn "Unknown log level ${TF_LOG}"
esac

UPDATE_OK='TfMod has been successfully updated!

You may now begin working with TfMod. Try running "tfmod init" to create
your first project. All TfMod commands should now work.

To update TfMod in the future, run "tfmod update"!'

function update-ok {
  ok "${UPDATE_OK}"
}

ERR_UPDATE='Failed to install or update TfMod'
ERR_UPDATE_MSG='This is probably a bug in TfMod. File an issue at:

    https://github.com/jfhbrook/TfMod/issues
'

function fatal-update {
  fatal "${ERR_UPDATE}" "${ERR_UPDATE_MSG}"
}

# Confirm y/n
function confirm {
  local choice
  read -r -p "${1} (y/N) " choice
  case "${choice}" in
    y|yes|Y|YES)
      return 0
      ;;
    *)
      fatal 'Cowardly refusing to continue.'
      ;;
  esac
}

# OS detection

function is-macos {
  if [[ "${OSTYPE}" == "darwin"* ]]; then
    debug 'MacOS detected'
    return 0
  fi
  return 1
}

# Check if a bin is installed

# We check for terraform twice on MacOS, so this helps cut down on the
# logging
TERRAFORM_IN_PATH=''

function has-bin {
  if [ "${1}" == 'terraform' ] && [ -n "${TERRAFORM_IN_PATH}" ]; then
    return 0
  fi

  if which "${1}" > /dev/null 2>&1; then
    info "Found ${1} at $(which "${1}")"
    if [ "${1}" == 'terraform' ]; then
      TERRAFORM_IN_PATH=1
    fi
    return 0
  fi

  info "Could not find ${1}"
  return 1
}

PACKAGES=()

function use-package {
  local cmd
  local pkg

  cmd="${1}"
  pkg="${2:-${1}}"

  if ! has-bin "${cmd}"; then
    PACKAGES+=("${pkg}")
  fi
}

function no-packages {
  [ ${#PACKAGES[@]} -eq 0 ]
}

# homebrew based installs

function install-homebrew {
  if confirm 'Would you like to install homebrew?'; then
    /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
    info 'Homebrew installed'
    return 0
  fi
  return 1
}

function brew-install {
  if no-packages; then return 0; fi

  if ! has-bin brew; then
    install-homebrew
  fi

  echo 'Installing the following homebrew formulas:'
  for formula in "${HOMEBREW_FORMULAS[@]}"; do
    echo "- ${formula}"
  done

  # Homebrew doesn't prompt by default
  if confirm 'Would you like to install these formulas with homebrew?'; then
    brew install "${HOMEBREW_FORMULAS[@]}" | quote
    return 0
  fi
  return 1
}

# linux-based installs

function apt-install {
  if no-packages; then return 0; fi
  sudo apt install "${PACKAGES[@]}"
}

function dnf-install {
  if no-packages; then return 0; fi
  sudo dnf install "${PACKAGES[@]}"
}

# do it up

function install-brew-packages {
  use-package git
  use-package python
  use-package terraform hashicorp/tap/terraform
  brew-install
}

function install-apt-packages {
  use-package git
  use-package python3
  apt-install
}

function install-dnf-packages {
  use-package git
  use-package python3
  dnf-install
}

function install-packages {
  if is-macos; then
    install-brew-packages
  elif has-bin apt; then
    install-apt-packages
  elif has-bin dnf; then
    install-dnf-packages
  else
    fatal 'Do not know how to install packages'
  fi
}

# uv related shenanigans

UV_BIN=''

function find-uv {
  if [ -n "${UV_BIN}" ]; then
    return 0
  fi

  if which uv &> /dev/null; then
    UV_BIN="$(which uv)"
  elif [ -f "${XDG_BIN_HOME}/uv" ]; then
    UV_BIN="${XDG_BIN_HOME}/uv"
  elif [ -f "${XDG_DATA_HOME}/../bin/uv" ]; then
    UV_BIN="$(realpath "${XDG_DATA_HOME}/../bin/uv")"
  elif [ -f "${HOME}/.local/bin/uv" ]; then
    UV_BIN="${HOME}/.local/bin/uv"
  fi

  if [ -n "${UV_BIN}" ]; then
    info "found uv at ${UV_BIN}"
    return 0
  fi
  return 1
}

function assert-uv {
  if [ -z "${UV_BIN}" ]; then
    fatal 'Could not find uv'
  fi
}

function install-uv {
  if find-uv; then
    return 0
  fi

  echo 'uv is installed with the following command:'
  echo
  echo '    curl -LsSf https://astral.sh/uv/install.sh | sh'
  echo

  if confirm 'Would you like to install uv?'; then
    curl -LsSf https://astral.sh/uv/install.sh | sh
    return 0
  fi
  return 1
}

function install-terraform {
  if has-bin terraform; then
    return 0
  fi

  fatal 'Without terraform, TfMod can not continue' \
'In order to use TfMod, you need to install terraform. You may find instructions
here:

    https://developer.hashicorp.com/terraform/tutorials/aws-get-started/install-cli
alternately, consider the tool '\'tfswitch\'':

    https://tfswitch.warrensbox.com/'
}

function install-TfMod {
  mkdir -p ~/.local/state

  if [ ! -d ~/.local/state/TfMod ]; then
    echo 'Installing TfMod to ~/.local/state/tfmod...'
    (cd ~/.local/state && git clone git@github.com:jfhbrook/TfMod.git 1>&1 | quote)
  else
    echo 'Updating TfMod source in ~/.local/state/tfmod...'
    (cd ~/.local/state/TfMod && git pull origin 2>&1 | quote)
  fi
  find-uv
  assert-uv
  echo 'Updating Terraform modules...'
  (set -euo pipefail; cd ~/.local/state/TfMod \
    && for module in ./modules/*; do \
        echo "- modules/$(basename "${module}")"
        terraform -no-color "-chdir=${module}" init -upgrade | quote
      done)
  echo 'Updating Python dependencies...'
  (set -euo pipefail cd ~/.local/state/TfMod \
    && rm -rf .venv \
    && "${UV_BIN}" sync 2>&1 | quote)

  if [ -z "${CALLED_FROM_INSTALLER:-}" ]; then
    echo 'Copying TfMod to ~/.local/bin/tfmod...'
    mkdir -p ~/.local/bin
    cp ~/.local/state/TfMod/bin/tfmod ~/.local/bin/tfmod
  fi
  chmod +x ~/.local/bin/TfMod
}

function check-path {
  if ! which TfMod &> /dev/null; then
    warn 'TfMod not found on your PATH. you may need to add the following to your'
    warn 'shell profile (ie ~/.bashrc, ~/.zshrc):'
    warn
    # shellcheck disable=SC2016
    warn '    export PATH="${PATH}:${HOME}/.local/bin"'
    warn
  fi
}

function install {
  install-packages
  install-terraform
  install-uv
  install-TfMod
  check-path
  update-ok
}

install || fatal-update
